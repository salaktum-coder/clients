<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GO2cam ‚Äî Acc√®s s√©curis√©</title>
  <meta name="theme-color" content="#00f7ff" />
  <style>
    :root{--bg:#0d0d0d;--card:#141414;--stroke:#2a2a2a;--txt:#e5e7eb;--muted:#9ca3af;--brand:#00f7ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;background:#0d0d0d;color:var(--txt)}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:min(560px,92%);background:var(--card);border:1px solid var(--stroke);border-radius:18px;padding:28px;box-shadow:0 0 10px #00f7ff22}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .dot{width:14px;height:14px;border-radius:4px;background:var(--brand);box-shadow:0 0 14px var(--brand)}
    h1{margin:.25rem 0 1rem 0}
    p{color:var(--muted);margin:.25rem 0}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #3a3a3a;background:#0f0f0f;color:var(--txt)}
    input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px #00f7ff40}
    .btn{width:100%;padding:12px;border-radius:12px;border:1px solid transparent;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--brand);color:#031517;box-shadow:0 0 12px #00f7ff}
    #msg{color:var(--muted);min-height:1.2em;margin-top:6px}
    .center{display:flex;justify-content:center}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="brand">
        <div class="dot"></div>
        <div style="font-weight:800;color:var(--brand);letter-spacing:.5px">GO2cam</div>
      </div>
      <h1>Acc√®s s√©curis√©</h1>

      <!-- √âtape e-mail -->
      <div id="stepEmail" style="display:flex;flex-direction:column;gap:.6rem;margin-top:12px">
        <p>Entrez votre e-mail pour recevoir un code √† 6 chiffres.</p>
        <input id="email" type="email" placeholder="Adresse e-mail" autocomplete="email" />
        <button id="sendBtn" class="btn btn-primary">Recevoir le code</button>
      </div>

      <!-- √âtape code -->
      <div id="stepOtp" style="display:none;flex-direction:column;gap:.6rem;margin-top:12px">
        <div class="center"><p>Un code √† 6 chiffres vient d‚Äô√™tre envoy√©.</p></div>
        <input id="otp" inputmode="numeric" autocomplete="one-time-code" placeholder="Code √† 6 chiffres" style="letter-spacing:4px;text-align:center;font-weight:700" />
        <button id="verifyBtn" class="btn btn-primary">Valider le code</button>
      </div>

      <p id="msg"></p>
    </section>
  </main>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG √Ä AJUSTER SI BESOIN ======
    const SUPABASE_URL      = "https://jsmgnchubnkkfhyuadpx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzbWduY2h1Ym5ra2ZoeXVhZHB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTI0ODksImV4cCI6MjA3NjM2ODQ4OX0.Q3ZkOKkaYv70tfLz9bEjrkof5RcLbDV_MkXehk8sJ_E";

    const STORAGE_BUCKET    = "prive";
    const PRIVATE_FILE_PATH = "client/go2cam_maintenance_2026_v6.html"; // chemin exact dans Storage
    const EXPIRY_SECONDS    = 900; // 15 minutes
    const REDIRECT_URL      = "https://salaktum-coder.github.io/clients/";
    // ========================================

    // Session NON persist√©e ‚Üí √©vite la reconnexion automatique apr√®s fermeture du navigateur
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: false }
    });

    const stepEmail = document.getElementById('stepEmail');
    const stepOtp   = document.getElementById('stepOtp');
    const emailEl   = document.getElementById('email');
    const otpEl     = document.getElementById('otp');
    const sendBtn   = document.getElementById('sendBtn');
    const verifyBtn = document.getElementById('verifyBtn');
    const msg       = document.getElementById('msg');

    let currentEmail = null;

    // Ouvre le HTML priv√© via URL sign√©e (avec un message clair si non autoris√©)
    async function openPrivateHtmlAsPage(bucket, path, expiresSec = 900) {
      const { data: signed, error: signErr } = await supabase
        .storage.from(bucket)
        .createSignedUrl(path, expiresSec, { download: false });

      if (signErr || !signed?.signedUrl) {
        const apiMsg = signErr?.message || "inconnue";
        if (/401|403|permission|not allowed|Unauthorized/i.test(apiMsg)) {
          throw new Error("Acc√®s refus√© : votre e-mail n‚Äôest pas autoris√©. Veuillez vous connecter avec l‚Äôadresse qui a re√ßu l‚Äôe-mail GO2cam.");
        }
        throw new Error("Acc√®s refus√© : cette adresse n‚Äôest pas autoris√©e. Connectez-vous avec l‚Äôadresse qui a re√ßu l‚Äôe-mail GO2cam.");
      }

      const res = await fetch(signed.signedUrl + `&nocache=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          throw new Error("Acc√®s refus√© : votre e-mail n‚Äôest pas autoris√©. Veuillez utiliser l‚Äôadresse qui a re√ßu l‚Äôe-mail GO2cam.");
        }
        throw new Error("Impossible de charger le contenu s√©curis√© (HTTP " + res.status + ").");
      }

      const html = await res.text();
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const url  = URL.createObjectURL(blob);
      window.location.href = url;
    }

    // 1) Envoi OTP
    sendBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = (emailEl.value || "").trim();
      if (!email) { msg.textContent = "Entrez un e-mail valide."; return; }
      msg.textContent = "Envoi du code‚Ä¶";
      currentEmail = email;

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { shouldCreateUser: true, emailRedirectTo: REDIRECT_URL }
      });
      if (error) { msg.textContent = "Erreur d‚Äôenvoi : " + (error.message || "inconnue"); return; }

      msg.textContent = "Code envoy√©. V√©rifiez votre bo√Æte mail (et vos spams).";
      stepEmail.style.display = "none";
      stepOtp.style.display   = "flex";
      otpEl.focus();
    });

    // 2) V√©rification OTP
    verifyBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const code = (otpEl.value || "").trim();
      if (!code) { msg.textContent = "Saisissez le code re√ßu."; return; }
      msg.textContent = "V√©rification‚Ä¶";

      const { error } = await supabase.auth.verifyOtp({
        email: currentEmail,
        token: code,
        type: "email"
      });

      if (error) {
        // Message clair si le code est invalide/expir√©
        msg.textContent = "Code invalide ou expir√©. R√©essayez.";
        return;
      }

      msg.textContent = "Connexion r√©ussie. Ouverture‚Ä¶";
      try {
        await openPrivateHtmlAsPage(STORAGE_BUCKET, PRIVATE_FILE_PATH, EXPIRY_SECONDS);
      } catch (e2) {
        // üëâ Message PRO si l‚Äôe-mail n‚Äôest pas autoris√©
        msg.textContent = e2.message || "Acc√®s refus√© : cette adresse n‚Äôest pas autoris√©e. Connectez-vous avec l‚Äôadresse qui a re√ßu l‚Äôe-mail GO2cam.";
      }
    });

    // 3) Si une session temporaire existe (rafra√Æchissement), on tente l‚Äôouverture
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        try {
          msg.textContent = "Session d√©tect√©e. Ouverture‚Ä¶";
          await openPrivateHtmlAsPage(STORAGE_BUCKET, PRIVATE_FILE_PATH, EXPIRY_SECONDS);
        } catch (e) {
          msg.textContent = e.message || "Acc√®s refus√©.";
          stepEmail.style.display = "flex";
          stepOtp.style.display   = "none";
        }
      }
    })();

    // D√©connexion quand on quitte/ferme la page (pour √©viter la reconnexion auto)
    window.addEventListener("pagehide", () => { supabase.auth.signOut().catch(()=>{}); });
    window.addEventListener("beforeunload", () => { supabase.auth.signOut().catch(()=>{}); });
  </script>
</body>
</html>
