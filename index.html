<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GO2cam — Accès sécurisé</title>
  <meta name="theme-color" content="#00f7ff">
  <style>
    :root{--bg:#0d0d0d;--card:#141414;--stroke:#2a2a2a;--txt:#e5e7eb;--muted:#9ca3af;--brand:#00f7ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;background:#0d0d0d;color:var(--txt)}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:min(560px,92%);background:var(--card);border:1px solid var(--stroke);border-radius:18px;padding:28px;box-shadow:0 0 10px #00f7ff22}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .dot{width:14px;height:14px;border-radius:4px;background:var(--brand);box-shadow:0 0 14px var(--brand)}
    h1{margin:.25rem 0 1rem 0}
    p{color:var(--muted);margin:.25rem 0}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #3a3a3a;background:#0f0f0f;color:var(--txt)}
    input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px #00f7ff40}
    .btn{width:100%;padding:12px;border-radius:12px;border:1px solid transparent;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-primary{background:var(--brand);color:#031517;box-shadow:0 0 12px #00f7ff}
    #msg{color:var(--muted);min-height:1.4em;margin-top:8px}
    .row{display:flex;flex-direction:column;gap:.6rem;margin-top:12px}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="brand">
        <div class="dot"></div>
        <div style="font-weight:800;color:var(--brand);letter-spacing:.5px">GO2cam</div>
      </div>
      <h1>Accès sécurisé</h1>
      <p>Entrez votre e-mail pour recevoir un code à 6 chiffres.</p>

      <!-- Étape e-mail -->
      <div id="stepEmail" class="row">
        <input id="email" type="email" placeholder="Adresse e-mail" autocomplete="email" />
        <button id="sendBtn" class="btn btn-primary">Recevoir le code</button>
      </div>

      <!-- Étape code -->
      <div id="stepOtp" class="row" style="display:none">
        <input id="otp" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Code à 6 chiffres"
               style="letter-spacing:4px;text-align:center;font-weight:700" />
        <button id="verifyBtn" class="btn btn-primary">Valider le code</button>
      </div>

      <p id="msg"></p>
    </section>
  </main>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === CONFIG À ADAPTER ===
    const SUPABASE_URL       = "https://jsmgnchubnkkfhyuadpx.supabase.co";
    const SUPABASE_ANON_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzbWduY2h1Ym5ra2ZoeXVhZHB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTI0ODksImV4cCI6MjA3NjM2ODQ4OX0.Q3ZkOKkaYv70tfLz9bEjrkof5RcLbDV_MkXehk8sJ_E";
    const STORAGE_BUCKET     = "prive";  // ID exact du bucket
    const PRIVATE_FILE_PATH  = "client/go2cam_maintenance_2026_v6.html"; // chemin exact dans le bucket
    const REDIRECT_URL       = "https://salaktum-coder.github.io/clients/";
    const SIGNED_URL_TTL     = 900; // 15 minutes
    // ========================

    const supabase  = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const stepEmail = document.getElementById('stepEmail');
    const stepOtp   = document.getElementById('stepOtp');
    const emailEl   = document.getElementById('email');
    const otpEl     = document.getElementById('otp');
    const sendBtn   = document.getElementById('sendBtn');
    const verifyBtn = document.getElementById('verifyBtn');
    const msg       = document.getElementById('msg');

    let currentEmail = null;

    function setLoading(el, isLoading, textWhenLoading="Patientez…") {
      if (!el.dataset.label) el.dataset.label = el.textContent;
      el.disabled = !!isLoading;
      el.textContent = isLoading ? textWhenLoading : el.dataset.label;
    }

    async function redirectToPrivateFile() {
      const { data: signed, error: signErr } = await supabase
        .storage.from(STORAGE_BUCKET)
        .createSignedUrl(PRIVATE_FILE_PATH, SIGNED_URL_TTL);

      if (signErr) {
        const m = (signErr.message || "").toLowerCase();
        if (m.includes("permission")) {
          // Message clair si l’e-mail n’est pas dans la table allowed_emails (policy Storage)
          msg.textContent = "Adresse e-mail non autorisée. Utilisez l’adresse e-mail à laquelle nous vous avons envoyé notre message.";
        } else if (m.includes("object not found")) {
          msg.textContent = "Contenu introuvable (vérifiez le chemin du fichier dans Storage).";
        } else {
          msg.textContent = "Erreur Storage : " + (signErr.message || "voir console");
        }
        return;
      }
      // Redirection plein écran vers le contenu privé
      window.location.href = signed.signedUrl;
    }

    // 1) Envoi du code OTP
    sendBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = (emailEl.value || "").trim();
      if (!email) { msg.textContent = "Saisissez une adresse e-mail valide."; return; }

      msg.textContent = "Envoi du code…";
      setLoading(sendBtn, true);
      currentEmail = email;

      // On ne parle jamais d’“inscription” côté UI.
      // shouldCreateUser:true = OK : l’utilisateur reçoit un code, puis l’accès est contrôlé par la policy Storage.
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { shouldCreateUser: true, emailRedirectTo: REDIRECT_URL }
      });

      setLoading(sendBtn, false);

      if (error) {
        msg.textContent = "Impossible d'envoyer le code : " + error.message;
        return;
      }

      msg.textContent = "Code envoyé. Vérifiez votre boîte mail (pensez aux spams).";
      stepEmail.style.display = "none";
      stepOtp.style.display   = "flex";
      otpEl.focus();
    });

    // 2) Vérification du code
    verifyBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const code = (otpEl.value || "").trim();
      if (!code) { msg.textContent = "Saisissez le code reçu par e-mail."; return; }

      msg.textContent = "Vérification du code…";
      setLoading(verifyBtn, true);

      const { error } = await supabase.auth.verifyOtp({
        email: currentEmail,
        token: code,
        type: "email"
      });

      setLoading(verifyBtn, false);

      if (error) {
        msg.textContent = "Code invalide ou expiré. Demandez un nouveau code.";
        return;
      }

      msg.textContent = "Connexion validée. Ouverture…";
      await redirectToPrivateFile();
    });

    // 3) Session déjà active → accès direct
    (async () => {
      const { data:{ session } } = await supabase.auth.getSession();
      if (session) await redirectToPrivateFile();
    })();

    // Entrée clavier (Enter)
    emailEl.addEventListener('keydown', e => { if (e.key === 'Enter') sendBtn.click(); });
    otpEl.addEventListener('keydown',   e => { if (e.key === 'Enter') verifyBtn.click(); });
  </script>
  <script>
async function redirectToPrivateFile() {
  // 1) Essai direct avec le chemin déclaré
  try {
    const { data, error } = await supabase
      .storage.from(STORAGE_BUCKET)
      .createSignedUrl(PRIVATE_FILE_PATH, SIGNED_URL_TTL);

    if (!error && data?.signedUrl) {
      window.location.href = data.signedUrl;
      return;
    }

    // 2) Si "not found" → on auto-découvre le VRAI nom dans le dossier "client/"
    //    (Pratique si un caractère, une casse, ou un espace traîne quelque part)
    const { data: items, error: listErr } = await supabase
      .storage.from(STORAGE_BUCKET)
      .list("client", { limit: 1000 });

    if (listErr) {
      console.error("[LIST error]", listErr);
      msg.textContent = "Impossible de lister les fichiers (policy Storage ?).";
      return;
    }

    // On cherche un .html plausible
    const best = (items || []).find(f =>
      f.name === "go2cam_maintenance_2026_v6.html"
    ) || (items || []).find(f =>
      /\.html?$/i.test(f.name)
    );

    if (!best) {
      msg.innerHTML =
        "Contenu introuvable (aucun .html trouvé dans <code>client/</code>).<br>" +
        "Fichiers présents : " + (items || []).map(x => x.name).join(", ");
      console.warn("[LIST]", items);
      return;
    }

    // 3) On retente avec le nom découvert
    const discoveredPath = "client/" + best.name;
    console.log("[DISCOVERED]", discoveredPath);

    const { data: signed2, error: err2 } = await supabase
      .storage.from(STORAGE_BUCKET)
      .createSignedUrl(discoveredPath, SIGNED_URL_TTL);

    if (err2) {
      console.error("[createSignedUrl discovered error]", err2);
      msg.textContent = "Toujours introuvable. Vérifie le chemin exact & la casse.";
      return;
    }

    window.location.href = signed2.signedUrl;
  } catch (e) {
    console.error(e);
    msg.textContent = "Erreur inattendue (voir console).";
  }
}
</script>

</body>
</html>
