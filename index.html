<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GO2cam — Accès sécurisé</title>
  <meta name="theme-color" content="#00f7ff">
  <style>
    :root{--bg:#0d0d0d;--card:#141414;--stroke:#2a2a2a;--txt:#e5e7eb;--muted:#9ca3af;--brand:#00f7ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;background:#0d0d0d;color:var(--txt)}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:min(560px,92%);background:var(--card);border:1px solid var(--stroke);border-radius:18px;padding:28px;box-shadow:0 0 10px #00f7ff22}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .dot{width:14px;height:14px;border-radius:4px;background:var(--brand);box-shadow:0 0 14px var(--brand)}
    h1{margin:.25rem 0 1rem 0}
    p{color:var(--muted);margin:.25rem 0}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #3a3a3a;background:#0f0f0f;color:var(--txt)}
    input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px #00f7ff40}
    .btn{width:100%;padding:12px;border-radius:12px;border:1px solid transparent;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--brand);color:#031517;box-shadow:0 0 12px #00f7ff}
    #msg{color:var(--muted);min-height:1.2em;margin-top:6px}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="brand">
        <div class="dot"></div>
        <div style="font-weight:800;color:var(--brand);letter-spacing:.5px">GO2cam</div>
      </div>
      <h1>Accès sécurisé</h1>
      <p>Espace réservé. Connectez-vous avec l’adresse e-mail autorisée et votre mot de passe.</p>

      <!-- Login: email + mot de passe -->
      <div id="stepPwd" style="display:flex;flex-direction:column;gap:.6rem;margin-top:12px">
        <input id="pwdEmail" type="email" placeholder="Adresse e-mail">
        <input id="pwdPass"  type="password" placeholder="Mot de passe">
        <button id="pwdLogin" class="btn btn-primary">Se connecter</button>
      </div>

      <p id="msg"></p>
    </section>
  </main>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ── CONFIG ────────────────────────────────────────────────────────────────
    const SUPABASE_URL      = "https://jsmgnchubnkkfhyuadpx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzbWduY2h1Ym5ra2ZoeXVhZHB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTI0ODksImV4cCI6MjA3NjM2ODQ4OX0.Q3ZkOKkaYv70tfLz9bEjrkof5RcLbDV_MkXehk8sJ_E";

    const STORAGE_BUCKET    = "prive";                                  // ID exact du bucket
    const PRIVATE_FILE_PATH = "client/go2cam_maintenance_2026_v6.html";  // SANS "/" au début
    const EXPIRY_SECONDS    = 900; // 15 min
    // ─────────────────────────────────────────────────────────────────────────

    const supabase  = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const emailEl   = document.getElementById('pwdEmail');
    const passEl    = document.getElementById('pwdPass');
    const loginBtn  = document.getElementById('pwdLogin');
    const msg       = document.getElementById('msg');

    // Ouvre la page privée (génère signed URL), puis déconnecte la session locale
    async function openPrivateAndSignOut() {
      // 1) Crée l’URL signée (nécessite la session active)
      const { data: signed, error: signErr } = await supabase
        .storage.from(STORAGE_BUCKET)
        .createSignedUrl(PRIVATE_FILE_PATH, EXPIRY_SECONDS);

      if (signErr) {
        console.error("[Storage] createSignedUrl error:", signErr, { bucket: STORAGE_BUCKET, path: PRIVATE_FILE_PATH });
        msg.textContent = "Erreur Storage : " + (signErr.message || "voir console");
        return;
      }

      // 2) Déconnecte tout de suite la session locale pour forcer la reconnexion à la prochaine visite
      await supabase.auth.signOut().catch(()=>{});

      // 3) Essaie une redirection plein écran ; si le MIME est mauvais, fallback en écriture
      try {
        const headRes = await fetch(signed.signedUrl, { method: "HEAD", cache: "no-store" });
        const ct = (headRes.headers.get("content-type") || "").toLowerCase();
        if (ct.includes("text/html")) {
          window.location.href = signed.signedUrl; // plein écran
          return;
        }
      } catch (_) {}

      // Fallback robuste (affiche même si Content-Type est mauvais)
      try {
        const res  = await fetch(signed.signedUrl, { cache: "no-store" });
        const html = await res.text();
        document.open(); document.write(html); document.close();
      } catch (e) {
        console.error("Render fallback error:", e);
        msg.textContent = "Impossible d'afficher le contenu sécurisé.";
      }
    }

    // Login mot de passe
    loginBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = (emailEl.value || "").trim();
      const password = (passEl.value || "");
      if (!email || !password) { msg.textContent = "Entrez votre e-mail et votre mot de passe."; return; }

      msg.textContent = "Connexion…";
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { msg.textContent = "Échec de connexion : " + error.message; return; }

      msg.textContent = "Connexion réussie. Ouverture…";
      await openPrivateAndSignOut(); // génère l'accès puis supprime la session locale
    });

    // Si une session traîne (cas rare), on NE l'utilise PAS : on force la saisie à chaque fois.
    // => Pas d'auto-login ici. (Si tu veux autoriser la reconnexion auto plus tard, on réactivera getSession()).
  </script>
</body>
</html>
